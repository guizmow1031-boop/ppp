<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Google Sign-In</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }
        .status {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .status div {
            margin: 10px 0;
            padding: 10px;
            background: #3a3a3a;
            border-radius: 5px;
        }
        button {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        .success { color: #4ade80; }
        .error { color: #ef4444; }
        .warning { color: #fbbf24; }
        .log {
            background: #0a0a0a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .log div {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>üî• Test Google Sign-In Firebase</h1>
    
    <div class="status">
        <h2>√âtat actuel</h2>
        <div id="auth-status">‚è≥ Initialisation...</div>
        <div id="user-status">üë§ Utilisateur: En attente...</div>
        <div id="credits-status">üíé Cr√©dits: En attente...</div>
    </div>

    <div>
        <button id="test-anonymous">1Ô∏è‚É£ Test Connexion Anonyme</button>
        <button id="test-google">2Ô∏è‚É£ Test Google Sign-In (linkWithPopup)</button>
        <button id="test-credits">3Ô∏è‚É£ Test D√©duction Cr√©dit</button>
        <button id="clear-logs">üóëÔ∏è Effacer logs</button>
    </div>

    <div class="log" id="logs"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, linkWithPopup } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCBceabrOm3Hwxcs3N6GKgdJrpZLWnMcNU",
            authDomain: "iinador.firebaseapp.com",
            projectId: "iinador",
            storageBucket: "iinador.firebasestorage.app",
            messagingSenderId: "937236894682",
            appId: "1:937236894682:web:968d9a4d18fce03494a6e3",
            measurementId: "G-PXDFJVS4NL"
        };

        // Initialisation
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let currentUser = null;
        let currentCredits = 0;

        // Fonction de log
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ef4444' : type === 'success' ? '#4ade80' : type === 'warning' ? '#fbbf24' : '#d1d5db';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Mise √† jour du statut
        function updateStatus() {
            document.getElementById('auth-status').innerHTML = auth.currentUser 
                ? '<span class="success">‚úÖ Firebase Auth connect√©</span>' 
                : '<span class="error">‚ùå Non connect√©</span>';
            
            document.getElementById('user-status').innerHTML = currentUser
                ? `üë§ ${currentUser.isAnonymous ? 'üé≠ Anonyme' : 'üìß ' + currentUser.email}<br>üîë UID: ${currentUser.uid}`
                : '‚è≥ En attente...';
            
            document.getElementById('credits-status').textContent = `üíé Cr√©dits: ${currentCredits}`;
        }

        // √âcouter les changements d'auth
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                addLog(`‚úÖ Utilisateur connect√©: ${user.isAnonymous ? 'Anonyme' : user.email}`, 'success');
                addLog(`üîë UID: ${user.uid}`, 'info');
                updateStatus();
                await loadCredits();
            } else {
                addLog('‚ö†Ô∏è Aucun utilisateur connect√©', 'warning');
                updateStatus();
            }
        });

        // Charger les cr√©dits
        async function loadCredits() {
            if (!currentUser) return;
            
            const userRef = doc(db, "users", currentUser.uid);
            try {
                const docSnap = await getDoc(userRef);
                if (docSnap.exists()) {
                    currentCredits = docSnap.data().credits || 0;
                    addLog(`üíé Cr√©dits charg√©s: ${currentCredits}`, 'success');
                } else {
                    await setDoc(userRef, { credits: 10 });
                    currentCredits = 10;
                    addLog(`üìù Nouveau document cr√©√© avec 10 cr√©dits`, 'success');
                }
                updateStatus();
            } catch (error) {
                addLog(`‚ùå Erreur Firestore: ${error.message}`, 'error');
            }
        }

        // Test 1: Connexion anonyme
        document.getElementById('test-anonymous').addEventListener('click', async () => {
            addLog('üîÑ Test connexion anonyme...', 'info');
            try {
                const result = await signInAnonymously(auth);
                addLog('‚úÖ Connexion anonyme r√©ussie!', 'success');
                addLog(`üîë UID: ${result.user.uid}`, 'info');
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        });

        // Test 2: Google Sign-In avec linkWithPopup
        document.getElementById('test-google').addEventListener('click', async () => {
            if (!currentUser) {
                addLog('‚ùå Aucun utilisateur! Faites d\'abord le test 1', 'error');
                return;
            }

            if (!currentUser.isAnonymous) {
                addLog('‚úÖ D√©j√† connect√© avec Google: ' + currentUser.email, 'success');
                return;
            }

            addLog('üîó Tentative de liaison avec Google...', 'info');
            addLog('ü™ü Ouverture de la popup Google...', 'warning');

            try {
                const result = await linkWithPopup(currentUser, googleProvider);
                addLog('‚úÖ‚úÖ‚úÖ Compte li√© avec succ√®s!', 'success');
                addLog(`üìß Email: ${result.user.email}`, 'success');
                addLog(`üîë UID conserv√©: ${result.user.uid}`, 'success');
            } catch (error) {
                addLog(`‚ùå Erreur linkWithPopup: ${error.code}`, 'error');
                addLog(`‚ùå Message: ${error.message}`, 'error');
                
                if (error.code === 'auth/popup-blocked') {
                    addLog('‚ö†Ô∏è POPUP BLOQU√âE! Autorisez les popups dans votre navigateur', 'warning');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    addLog('‚ö†Ô∏è Popup ferm√©e par l\'utilisateur', 'warning');
                }
            }
        });

        // Test 3: D√©duction cr√©dit
        document.getElementById('test-credits').addEventListener('click', async () => {
            if (!currentUser) {
                addLog('‚ùå Aucun utilisateur connect√©', 'error');
                return;
            }

            if (currentCredits <= 0) {
                addLog('‚ùå Aucun cr√©dit disponible', 'error');
                return;
            }

            addLog(`üí≥ D√©duction d'1 cr√©dit (actuellement: ${currentCredits})...`, 'info');
            
            try {
                const newCredits = currentCredits - 1;
                const userRef = doc(db, "users", currentUser.uid);
                await updateDoc(userRef, { credits: newCredits });
                currentCredits = newCredits;
                addLog(`‚úÖ Cr√©dit d√©duit! Nouveau total: ${currentCredits}`, 'success');
                updateStatus();
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        });

        // Effacer les logs
        document.getElementById('clear-logs').addEventListener('click', () => {
            document.getElementById('logs').innerHTML = '';
        });

        addLog('üî• Page de test charg√©e', 'success');
        addLog('üìù Configuration Firebase OK', 'success');
    </script>
</body>
</html>
